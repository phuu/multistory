<!doctype html>
<html ng-app="story-parse" ng-controller="StoryParseCtrl">
<meta charset="utf8">
<title>User Story Parser</title>

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 0;
    font: 14px/1.5 sans-serif;
    padding: 1em;
    padding-left: 51vw;
  }
  h1, h2 {
    margin: 0;
  }
  textarea {
    display: block;
    width: 50vw;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    border: none;
    border-right: 1px solid #444;
    padding: 1em;
    font: 14px/1.5 sans-serif;
  }
  textarea:focus {
    outline: none;
    background: #fafafa;
  }
</style>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.1.3/angular.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>

<textarea ng-model="file.raw" ng-change="parse()"></textarea>

<div ng-repeat="stories in file.groups | toArray | storyOrder">
  <h2>{{stories.$key}}</h2>
  <ul>
    <li ng-repeat="story in stories">
      <strong>{{story.who}}</strong> : {{story.what}} : <em>{{story.why}}</em>
    </li>
  </ul>
</div>

<script>

angular.module('story-parse', [])

.factory('storage', function () {
  return {
    get: function (identifier) {
      return JSON.parse(localStorage.getItem(identifier)) || undefined;
    },
    save: function (identifier, data) {
      return localStorage.setItem(identifier, JSON.stringify(data));
    }
  };
})

.filter('toArray', function () {
  return function (obj) {
    return Object.keys(obj).map(function (key) {
      obj[key].$key = key;
      return obj[key];
    });
  };
})

.filter('storyOrder', function () {
  var lookup = {
    'icebox': 100,
    'backlog': 90,
    'in progress': 80,
    'in testing': 60,
    'done': 40
  };
  return function (array) {
    return array.sort(function (a, b) {

      var aVal = lookup[a.$key.toLowerCase().trim()] || 1000,
          bVal = lookup[b.$key.toLowerCase().trim()] || 1000;
      return aVal - bVal;
    });
  };
})

.controller('StoryParseCtrl', function ($scope, storage) {

  $scope.file = storage.get('file') || {
    raw: 'Paste your user stories file here.',
    groups: []
  };

  $scope.parse = function () {
    var lines = $scope.file.raw.split('\n'),
        groupname = 'icebox';

    $scope.file.groups = {};

    lines.forEach(function (line, index) {

      if (line.match('---')) {
        groupname = lines[index - 1].trim().toLowerCase();
        if (!$scope.file.groups[groupname]) $scope.file.groups[groupname] = [];
      }

      var res = line.match(/([A-Z\s']+)[A-Za-z\s.,!']([A-Z\s']+)[A-Za-z\s.,!']([A-Z\s']+)/g);

      if (!res) return;

      var cleaned = res.map(function (segment, index) {
        var str = (segment || '')
                    .replace(',', '')
                    .replace(/as a/i, '')
                    .trim();
        if (index === 0) str = str.replace(' I', '').trim();
        return str.toLowerCase();
      });


      cleaned = cleaned.slice(0,2).concat(cleaned.slice(2).join(' '));

      $scope.file.groups[groupname].push(_.object(['who', 'what', 'why'], cleaned));

    });

    storage.save('file', $scope.file);
  };

})

</script>